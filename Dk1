local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- Th·ªùi gian m·∫∑c ƒë·ªãnh
local respawnTime = 20
local autoEnabled = false
local countdown = respawnTime
local moveDuration = 7 -- th·ªùi gian t·ª± ch·∫°y th·∫≥ng (gi√¢y)

--====================================
-- GUI
--====================================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BaseSystemGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = player:WaitForChild("PlayerGui")

-- N√∫t ·∫©n/hi·ªán
local toggleMainBtn = Instance.new("TextButton", ScreenGui)
toggleMainBtn.Size = UDim2.new(0,120,0,40)
toggleMainBtn.Position = UDim2.new(0.85,0,0.05,0) -- g√≥c tr√™n b√™n ph·∫£i
toggleMainBtn.BackgroundColor3 = Color3.fromRGB(80,80,80)
toggleMainBtn.TextColor3 = Color3.new(1,1,1)
toggleMainBtn.Text = "üìã Menu"
toggleMainBtn.Active = true
toggleMainBtn.Draggable = true

-- B·∫£ng ch√≠nh
local mainFrame = Instance.new("Frame", ScreenGui)
mainFrame.Size = UDim2.new(0, 220, 0, 150)
mainFrame.Position = UDim2.new(0, 20, 0, 100)
mainFrame.BackgroundColor3 = Color3.fromRGB(40,40,40)
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Visible = true

-- Ti√™u ƒë·ªÅ
local title = Instance.new("TextLabel", mainFrame)
title.Size = UDim2.new(1,0,0,30)
title.BackgroundColor3 = Color3.fromRGB(20,20,20)
title.TextColor3 = Color3.new(1,1,1)
title.Text = "‚öî Auto Base System"

-- N√∫t b·∫≠t/t·∫Øt Auto
local toggleBtn = Instance.new("TextButton", mainFrame)
toggleBtn.Size = UDim2.new(0.9,0,0,30)
toggleBtn.Position = UDim2.new(0.05,0,0,40)
toggleBtn.Text = "‚ñ∂Ô∏è B·∫≠t Auto"
toggleBtn.BackgroundColor3 = Color3.fromRGB(0,120,0)
toggleBtn.TextColor3 = Color3.new(1,1,1)

-- √î nh·∫≠p s·ªë gi√¢y
local timeBox = Instance.new("TextBox", mainFrame)
timeBox.Size = UDim2.new(0.9,0,0,30)
timeBox.Position = UDim2.new(0.05,0,0,80)
timeBox.PlaceholderText = "Nh·∫≠p th·ªùi gian (gi√¢y)"
timeBox.Text = ""
timeBox.BackgroundColor3 = Color3.fromRGB(60,60,60)
timeBox.TextColor3 = Color3.new(1,1,1)

-- Label tr·∫°ng th√°i
local statusLabel = Instance.new("TextLabel", mainFrame)
statusLabel.Size = UDim2.new(0.9,0,0,30)
statusLabel.Position = UDim2.new(0.05,0,0,120)
statusLabel.BackgroundTransparency = 1
statusLabel.TextColor3 = Color3.new(1,1,1)
statusLabel.Text = "Tr·∫°ng th√°i: T·∫Øt"

--====================================
-- Ch·ª©c nƒÉng
--====================================
local function startAuto()
	autoEnabled = true
	toggleBtn.Text = "‚èπ T·∫Øt Auto"
	toggleBtn.BackgroundColor3 = Color3.fromRGB(120,0,0)
	statusLabel.Text = "Tr·∫°ng th√°i: B·∫≠t"
end

local function stopAuto()
	autoEnabled = false
	toggleBtn.Text = "‚ñ∂Ô∏è B·∫≠t Auto"
	toggleBtn.BackgroundColor3 = Color3.fromRGB(0,120,0)
	statusLabel.Text = "Tr·∫°ng th√°i: T·∫Øt"
end

-- Khi nh√¢n v·∫≠t spawn th√¨ script t·ª± ƒëi·ªÅu khi·ªÉn
player.CharacterAdded:Connect(function(char)
	if not autoEnabled then return end
	task.wait(1)

	local humanoid = char:WaitForChild("Humanoid")
	local hrp = char:WaitForChild("HumanoidRootPart")

	---------------------------------------------------
	-- ‚ú® B∆∞·ªõc 1: T·ª± ch·∫°y th·∫≥ng 7 gi√¢y sau khi spawn
	---------------------------------------------------
	statusLabel.Text = "üèÉ ƒêang ch·∫°y th·∫≥ng " .. moveDuration .. "s..."
	local startTime = tick()

	local connection
	connection = RunService.RenderStepped:Connect(function()
		if humanoid.Health <= 0 or tick() - startTime >= moveDuration or not autoEnabled then
			humanoid:Move(Vector3.new(0,0,0))
			if connection then connection:Disconnect() end
			statusLabel.Text = "‚úÖ ƒê√£ ch·∫°y xong, chu·∫©n b·ªã v·ªÅ Base"
			return
		end
		humanoid:Move(hrp.CFrame.LookVector)
	end)

	---------------------------------------------------
	-- ‚ú® B∆∞·ªõc 2: Sau ƒë√≥ m·ªõi di chuy·ªÉn v·ªÅ base + kh√≥a c·ª≠a
	---------------------------------------------------
	task.delay(moveDuration, function()
		if not autoEnabled or humanoid.Health <= 0 then return end

		local baseFolder = workspace:FindFirstChild("Bases")
		if not baseFolder then return end
		local base = baseFolder:FindFirstChild(player.Name)
		if not base then return end

		local targetPos = base.Position + Vector3.new(0,3,0)

		task.spawn(function()
			while autoEnabled and humanoid and humanoid.Health > 0 do
				humanoid:MoveTo(targetPos)
				local reached = humanoid.MoveToFinished:Wait()
				if reached then
					local door = base:FindFirstChild("Door")
					if door and door:IsA("Part") then
						door.CanCollide = true
						door.Transparency = 0
						print("Base c·ªßa "..player.Name.." ƒë√£ ƒë∆∞·ª£c kh√≥a!")
					end
					break
				end
			end
		end)

		---------------------------------------------------
		-- ‚ú® B∆∞·ªõc 3: Sau khi v·ªÅ Base m·ªõi b·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c reset
		---------------------------------------------------
		task.spawn(function()
			while autoEnabled do
				for i = respawnTime,1,-1 do
					if not autoEnabled then break end
					countdown = i
					statusLabel.Text = "Reset sau: "..countdown.."s"
					task.wait(1)
				end
				if autoEnabled and humanoid and humanoid.Health > 0 then
					humanoid.Health = 0
				end
			end
		end)
	end)
end)

-- N√∫t b·∫≠t/t·∫Øt Auto
toggleBtn.MouseButton1Click:Connect(function()
	if autoEnabled then
		stopAuto()
	else
		local val = tonumber(timeBox.Text)
		if val and val > 0 then
			respawnTime = val
		end
		startAuto()
	end
end)

-- N√∫t ·∫©n/hi·ªán b·∫£ng
toggleMainBtn.MouseButton1Click:Connect(function()
	mainFrame.Visible = not mainFrame.Visible
end)
