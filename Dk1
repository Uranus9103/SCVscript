-- Steal a Brainrot – ESP toggle bằng nút UI
-- Chỉ hiển thị Part/Model có tên chứa "Brain" hoặc tag "Brain"

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CollectionService = game:GetService("CollectionService")

local LocalPlayer = Players.LocalPlayer
local playerGui = LocalPlayer:WaitForChild("PlayerGui")

-- CONFIG
local ESP_ENABLED = false
local MAX_DISTANCE = 800
local TARGET_TAG = "Brain"
local TARGET_NAME_PARTIAL = "brain"
local UPDATE_INTERVAL = 0.1

local tracked = {}

-- UI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESP_UI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local btn = Instance.new("TextButton")
btn.Size = UDim2.new(0, 120, 0, 40)
btn.Position = UDim2.new(0, 10, 0, 200) -- đổi vị trí nếu cần
btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
btn.TextColor3 = Color3.new(1,1,1)
btn.Font = Enum.Font.SourceSansBold
btn.TextSize = 20
btn.Text = "ESP: Tắt"
btn.Parent = screenGui

local function updateButton()
    btn.Text = ESP_ENABLED and "ESP: Bật" or "ESP: Tắt"
    btn.BackgroundColor3 = ESP_ENABLED and Color3.fromRGB(0,170,0) or Color3.fromRGB(40,40,40)
end

btn.MouseButton1Click:Connect(function()
    ESP_ENABLED = not ESP_ENABLED
    updateButton()
    if not ESP_ENABLED then
        -- tắt thì xóa highlight luôn
        for inst,h in pairs(tracked) do
            if h and h.Parent then h:Destroy() end
        end
        tracked = {}
    end
end)

updateButton()

-- Helpers
local function canonicalTarget(inst)
    if inst:IsA("Model") then return inst end
    if inst:IsA("BasePart") then
        if inst.Parent and inst.Parent:IsA("Model") then
            return inst.Parent
        else
            return inst
        end
    end
    return nil
end

local function getPos(target)
    if target:IsA("Model") then
        if target.PrimaryPart then return target.PrimaryPart.Position end
        for _,v in ipairs(target:GetDescendants()) do
            if v:IsA("BasePart") then return v.Position end
        end
    elseif target:IsA("BasePart") then
        return target.Position
    end
    return nil
end

local function createHighlight(target)
    if tracked[target] then return end
    local h = Instance.new("Highlight")
    h.Name = "BrainESP"
    h.FillColor = Color3.fromRGB(255,200,60)
    h.FillTransparency = 0.4
    h.OutlineColor = Color3.fromRGB(255,255,255)
    h.OutlineTransparency = 0
    h.Adornee = target
    h.Parent = target
    tracked[target] = h
end

local function removeHighlight(target)
    if tracked[target] then
        tracked[target]:Destroy()
        tracked[target] = nil
    end
end

-- Update loop
local last = 0
RunService.RenderStepped:Connect(function(dt)
    last = last + dt
    if last < UPDATE_INTERVAL then return end
    last = 0

    if not ESP_ENABLED then return end

    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local myPos = hrp and hrp.Position

    local found = {}

    -- Tìm theo tag
    for _,inst in ipairs(CollectionService:GetTagged(TARGET_TAG)) do
        local t = canonicalTarget(inst)
        if t then found[t] = true end
    end
    -- Tìm theo tên chứa "brain"
    for _,inst in ipairs(workspace:GetDescendants()) do
        if inst:IsA("BasePart") or inst:IsA("Model") then
            local n = inst.Name:lower()
            if n:find(TARGET_NAME_PARTIAL) then
                local t = canonicalTarget(inst)
                if t then found[t] = true end
            end
        end
    end

    for t,_ in pairs(found) do
        local pos = getPos(t)
        if myPos and pos then
            if (pos - myPos).Magnitude <= MAX_DISTANCE then
                if not tracked[t] then createHighlight(t) end
            else
                removeHighlight(t)
            end
        end
    end

    for t,_ in pairs(tracked) do
        if not found[t] then
            removeHighlight(t)
        end
    end
end)
