local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local PathfindingService = game:GetService("PathfindingService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- Tr·∫°ng th√°i bay
local autoFlying = false
local currentTween

-- üîπ H√†m t√¨m Part cƒÉn c·ª© c·ªßa m·ªôt ng∆∞·ªùi
local function getHomePart(targetName)
	for _, obj in ipairs(workspace:GetDescendants()) do
		if obj:IsA("TextLabel") then
			local text = string.lower(obj.Text)
			if string.find(text, string.lower(targetName)) then
				local guiParent = obj:FindFirstAncestorWhichIsA("BillboardGui") or obj:FindFirstAncestorWhichIsA("SurfaceGui")
				if guiParent and guiParent.Adornee then
					return guiParent.Adornee
				elseif guiParent and guiParent.Parent:IsA("Part") then
					return guiParent.Parent
				end
			end
		end
	end
	return nil
end

-- üîπ Tween bay m∆∞·ª£t
local function tweenTo(targetPos)
	if not humanoidRootPart then return end
	if currentTween then currentTween:Cancel() end

	local distance = (targetPos - humanoidRootPart.Position).Magnitude
	local flyTime = distance / 60
	local tweenInfo = TweenInfo.new(flyTime, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut)
	local goal = { CFrame = CFrame.new(targetPos) }
	currentTween = TweenService:Create(humanoidRootPart, tweenInfo, goal)
	currentTween:Play()
	return currentTween
end

-- üîπ Bay b·∫±ng Pathfinding
local function flyPath(homePart)
	if not humanoidRootPart or not homePart then return end

	local path = PathfindingService:CreatePath({
		AgentRadius = 5,
		AgentHeight = 6,
		AgentCanJump = true,
		AgentCanClimb = true
	})

	path:ComputeAsync(humanoidRootPart.Position, homePart.Position + Vector3.new(0,5,0))

	if path.Status == Enum.PathStatus.Complete then
		local waypoints = path:GetWaypoints()
		for _, waypoint in ipairs(waypoints) do
			if not autoFlying then break end
			local target = waypoint.Position + Vector3.new(0, 5, 0)
			local tween = tweenTo(target)
			tween.Completed:Wait()
		end
		autoFlying = false
	else
		warn("Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng ƒë·∫øn nh√†!")
		autoFlying = false
	end
end

-- üîπ T·∫°o GUI danh s√°ch ng∆∞·ªùi ch∆°i
local gui = Instance.new("ScreenGui")
gui.Name = "HomeListGui"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 200, 0, 300)
frame.Position = UDim2.new(0, 20, 0, 100)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.Visible = false
frame.Parent = gui

local uiList = Instance.new("UIListLayout")
uiList.Parent = frame
uiList.SortOrder = Enum.SortOrder.LayoutOrder

local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 160, 0, 40)
toggleButton.Position = UDim2.new(0, 20, 0, 50)
toggleButton.Text = "Danh s√°ch nh√†"
toggleButton.BackgroundColor3 = Color3.fromRGB(50,150,250)
toggleButton.Parent = gui

-- üîπ H√†m c·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi ch∆°i
local function updatePlayerList()
	frame:ClearAllChildren()
	uiList.Parent = frame

	for _, plr in ipairs(Players:GetPlayers()) do
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, 0, 0, 40)
		btn.Text = plr.Name
		btn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
		btn.TextColor3 = Color3.fromRGB(255,255,255)
		btn.Parent = frame

		btn.MouseButton1Click:Connect(function()
			if autoFlying then
				if currentTween then currentTween:Cancel() end
				autoFlying = false
				btn.Text = plr.Name
				return
			end

			local homePart = getHomePart(plr.Name)
			if not homePart then
				btn.Text = "Kh√¥ng c√≥ nh√†!"
				return
			end
			btn.Text = "ƒêang bay..."
			autoFlying = true
			flyPath(homePart)
			btn.Text = plr.Name
		end)
	end
end

-- Toggle hi·ªán menu
toggleButton.MouseButton1Click:Connect(function()
	frame.Visible = not frame.Visible
	if frame.Visible then
		updatePlayerList()
	end
end)

-- C·∫≠p nh·∫≠t khi c√≥ ng∆∞·ªùi v√†o/ra
Players.PlayerAdded:Connect(updatePlayerList)
Players.PlayerRemoving:Connect(updatePlayerList)

-- N·∫øu nh√¢n v·∫≠t respawn
player.CharacterAdded:Connect(function(char)
	character = char
	humanoidRootPart = character:WaitForChild("HumanoidRootPart")
end)
