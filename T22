-- LockOnSkillSystem (LocalScript trong StarterPlayerScripts)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

-- Tạo RemoteEvent nếu chưa có
local useSkillEvent = ReplicatedStorage:FindFirstChild("UseSkillEvent")
if not useSkillEvent then
    useSkillEvent = Instance.new("RemoteEvent")
    useSkillEvent.Name = "UseSkillEvent"
    useSkillEvent.Parent = ReplicatedStorage
end

local skillVfxEvent = ReplicatedStorage:FindFirstChild("SkillVfxEvent")
if not skillVfxEvent then
    skillVfxEvent = Instance.new("RemoteEvent")
    skillVfxEvent.Name = "SkillVfxEvent"
    skillVfxEvent.Parent = ReplicatedStorage
end

-- Config
local SKILL_RANGE = 60
local SKILL_DAMAGE = 40
local COOLDOWN = 5
local lastUsed = {}

----------------------------------------------------------------
-- CLIENT: UI bật/tắt lock-on
----------------------------------------------------------------
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "LockOnGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = player:WaitForChild("PlayerGui")

local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0,120,0,40)
toggleButton.Position = UDim2.new(1,-140,1,-60)
toggleButton.Text = "Lock-On: OFF"
toggleButton.BackgroundColor3 = Color3.fromRGB(80,80,80)
toggleButton.TextColor3 = Color3.new(1,1,1)
toggleButton.Parent = ScreenGui

local lockOnEnabled = false
toggleButton.MouseButton1Click:Connect(function()
	lockOnEnabled = not lockOnEnabled
	if lockOnEnabled then
		toggleButton.Text = "Lock-On: ON"
		toggleButton.BackgroundColor3 = Color3.fromRGB(0,170,0)
	else
		toggleButton.Text = "Lock-On: OFF"
		toggleButton.BackgroundColor3 = Color3.fromRGB(80,80,80)
	end
end)

----------------------------------------------------------------
-- CLIENT: Gửi yêu cầu skill khi nhấn Q
----------------------------------------------------------------
local localCooldown = 0
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.KeyCode == Enum.KeyCode.Q then
		if tick() - localCooldown < COOLDOWN then return end
		localCooldown = tick()
		useSkillEvent:FireServer(lockOnEnabled) -- gửi trạng thái lock-on
	end
end)

-- CLIENT: Hiệu ứng
skillVfxEvent.OnClientEvent:Connect(function(action, data)
	if action == "NoTarget" then
		warn("Không có mục tiêu trong tầm!")
	elseif action == "Hit" then
		local attackerId, targetId, pos1, pos2 = unpack(data)
		local beamPart = Instance.new("Part")
		beamPart.Anchored = true
		beamPart.CanCollide = false
		beamPart.Transparency = 0.5
		beamPart.Color = Color3.new(1,0,0)
		beamPart.Size = Vector3.new(0.2,0.2,(pos1-pos2).Magnitude)
		beamPart.CFrame = CFrame.new(pos1, pos2) * CFrame.new(0,0,-beamPart.Size.Z/2)
		beamPart.Parent = workspace
		game:GetService("Debris"):AddItem(beamPart,0.3)
	end
end)

----------------------------------------------------------------
-- SERVER: Xử lý skill
----------------------------------------------------------------
if RunService:IsServer() then
	local function getCharInfo(plr)
		local char = plr.Character
		if not char then return end
		local hrp = char:FindFirstChild("HumanoidRootPart")
		local hum = char:FindFirstChildOfClass("Humanoid")
		if hrp and hum and hum.Health > 0 then
			return char, hrp, hum
		end
	end

	local function findTarget(attacker, attackerPos)
		local closest, minDist = nil, SKILL_RANGE+1
		for _, other in ipairs(Players:GetPlayers()) do
			if other ~= attacker then
				local oc, ohrp, ohum = getCharInfo(other)
				if oc and ohrp and ohum.Health > 0 then
					local dist = (ohrp.Position - attackerPos).Magnitude
					if dist < minDist and dist <= SKILL_RANGE then
						closest, minDist = other, dist
					end
				end
			end
		end
		return closest
	end

	useSkillEvent.OnServerEvent:Connect(function(plr, lockOnFlag)
		local now = tick()
		if lastUsed[plr] and now - lastUsed[plr] < COOLDOWN then return end
		lastUsed[plr] = now

		local c, hrp, hum = getCharInfo(plr)
		if not c then return end

		if lockOnFlag then
			-- Lock-on bật: tìm mục tiêu gần nhất
			local target = findTarget(plr, hrp.Position)
			if not target then
				skillVfxEvent:FireClient(plr,"NoTarget")
				return
			end
			local tc, thrp, thum = getCharInfo(target)
			if not tc then return end
			thum:TakeDamage(SKILL_DAMAGE)
			local data = {plr.UserId, target.UserId, hrp.Position, thrp.Position}
			skillVfxEvent:FireAllClients("Hit", data)
		else
			-- Lock-on tắt: ví dụ chỉ chơi hiệu ứng tại chỗ (không auto-hit)
			skillVfxEvent:FireClient(plr,"NoTarget")
		end
	end)
end
