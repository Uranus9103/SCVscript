local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer

--=====================================
-- GUI
--=====================================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "PushPartGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = player:WaitForChild("PlayerGui")

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 150, 0, 50)
button.Position = UDim2.new(1, -160, 0, 20)
button.Text = "Bật Đẩy"
button.TextColor3 = Color3.fromRGB(255,255,255)
button.Font = Enum.Font.GothamBold
button.TextSize = 20
button.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
button.AutoButtonColor = true
button.Parent = ScreenGui

local corner = Instance.new("UICorner", button)
corner.CornerRadius = UDim.new(0, 12)

local gradient = Instance.new("UIGradient", button)
gradient.Color = ColorSequence.new{
	ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 200, 255)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 120, 200))
}

-- Drag GUI
local dragging = false
local dragStart, startPos
button.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = button.Position
	end
end)
button.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
		if dragging then
			local delta = input.Position - dragStart
			button.Position = UDim2.new(
				startPos.X.Scale,
				startPos.X.Offset + delta.X,
				startPos.Y.Scale,
				startPos.Y.Offset + delta.Y
			)
		end
	end
end)
UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = false
	end
end)

--=====================================
-- Biến
--=====================================
local enabled = false
local firstToggle = true
local savedCFrame = nil
local pushPart = nil
local linearVel = nil
local pushForce = 40
local antiCheckDistance = 700

--=====================================
-- Hàm tạo Push Part
--=====================================
local function createPush(char)
	local hrp = char:WaitForChild("HumanoidRootPart")

	pushPart = Instance.new("Part")
	pushPart.Size = Vector3.new(2, 2, 0.5)
	pushPart.Color = Color3.fromRGB(0, 200, 255)
	pushPart.Anchored = false
	pushPart.CanCollide = false
	pushPart.Name = "PushPart"

	local weld = Instance.new("WeldConstraint")
	pushPart.Parent = char
	pushPart.CFrame = hrp.CFrame * CFrame.new(0, 0, -2)
	weld.Part0 = hrp
	weld.Part1 = pushPart
	weld.Parent = pushPart

	linearVel = Instance.new("LinearVelocity")
	linearVel.Attachment0 = Instance.new("Attachment", hrp)
	linearVel.MaxForce = 1e6
	linearVel.RelativeTo = Enum.ActuatorRelativeTo.World
	linearVel.VelocityConstraintMode = Enum.VelocityConstraintMode.Vector
	linearVel.VectorVelocity = Vector3.zero
	linearVel.Parent = hrp
end

local function destroyPush()
	if pushPart then pushPart:Destroy() pushPart = nil end
	if linearVel then linearVel:Destroy() linearVel = nil end
end

--=====================================
-- Toggle Push
--=====================================
local function togglePush()
	local char = player.Character
	if not char then return end
	local hrp = char:WaitForChild("HumanoidRootPart")
	local hum = char:WaitForChild("Humanoid")

	enabled = not enabled

	if enabled then
		-- Lần đầu bật: reset và lưu vị trí
		if firstToggle then
			firstToggle = false
			savedCFrame = hrp.CFrame
			player:LoadCharacter()
			button.Text = "Đang reset..."
			return
		end

		-- Bật lần 2: tự đẩy về vị trí đã lưu
		if savedCFrame then
			destroyPush()
			task.spawn(function()
				local char2 = player.Character or player.CharacterAdded:Wait()
				local hrp2 = char2:WaitForChild("HumanoidRootPart")
				local hum2 = char2:WaitForChild("Humanoid")

				local direction = (savedCFrame.Position - hrp2.Position).Unit
				linearVel = Instance.new("LinearVelocity")
				local attach = Instance.new("Attachment", hrp2)
				linearVel.Attachment0 = attach
				linearVel.MaxForce = 1e6
				linearVel.RelativeTo = Enum.ActuatorRelativeTo.World
				linearVel.VelocityConstraintMode = Enum.VelocityConstraintMode.Vector

				-- Loop nhỏ để né vật cản khi đi về
				local connection
				connection = RunService.RenderStepped:Connect(function()
					local rayParams = RaycastParams.new()
					rayParams.FilterDescendantsInstances = {char2}
					rayParams.FilterType = Enum.RaycastFilterType.Blacklist
					local rayResult = Workspace:Raycast(hrp2.Position, direction * 4, rayParams)
					if rayResult then
						linearVel.VectorVelocity = Vector3.zero
					else
						linearVel.VectorVelocity = direction * pushForce
					end

					-- nếu gần điểm lưu thì dừng
					if (hrp2.Position - savedCFrame.Position).Magnitude < 1 then
						linearVel.VectorVelocity = Vector3.zero
						linearVel:Destroy()
						connection:Disconnect()
					end
				end)
				linearVel.Parent = hrp2
			end)
			button.Text = "Đang tự đẩy về vị trí..."
		end
	else
		button.Text = "Bật Đẩy"
	end
end

--=====================================
-- CharacterAdded: anti die
--=====================================
player.CharacterAdded:Connect(function(char)
	local hrp = char:WaitForChild("HumanoidRootPart")
	char:WaitForChild("Humanoid")

	if savedCFrame and not firstToggle then
		task.wait(0.2)
		hrp.CFrame = savedCFrame
		button.Text = "Đã sẵn sàng để đẩy"
	end
end)

button.MouseButton1Click:Connect(togglePush)
