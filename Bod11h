-- Brainrot ESP Script (Hiển thị DisplayName)
local ESP_CONFIG = {
    Size = UDim2.new(0, 200, 0, 40),         -- Kích thước ESP
    Offset = Vector3.new(0, 3.5, 0),         -- Vị trí so với đầu nhân vật
    
    Text = {
        Font = Enum.Font.GothamBold,         -- Font chữ
        Color = Color3.fromRGB(255, 85, 255),-- Màu chữ brainrot
        Size = 18,                           -- Kích thước chữ
        StrokeColor = Color3.fromRGB(0, 0, 0), -- Màu viền chữ
        StrokeTransparency = 0,              -- 0 = hiện rõ, 1 = ẩn
    },
    
    Background = {
        Color = Color3.fromRGB(20, 20, 20),  -- Nền
        Transparency = 0.7,                  -- 0 = đặc, 1 = trong suốt
    },
    
    Border = {
        Enabled = true,                      -- Có viền khung hay không
        Thickness = 2,                       -- Độ dày viền
        Color = Color3.fromRGB(85, 0, 127),  -- Màu viền brainrot
    }
}

-- Chính
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local localPlayer = Players.LocalPlayer

_G.BrainrotESPEnabled = true
local espList = {}

local function clearESP()
    for _, esp in pairs(espList) do
        if esp and esp.Parent then
            esp:Destroy()
        end
    end
    table.clear(espList)
end

local function getPlayerDisplayName(player)
    -- Ưu tiên lấy DisplayName, nếu không có thì dùng username
    return player.DisplayName ~= player.Name and player.DisplayName or player.Name
end

local function findHumanoidRootPart(character)
    -- Tìm HumanoidRootPart hoặc Head của nhân vật
    if character:FindFirstChild("HumanoidRootPart") then
        return character.HumanoidRootPart
    elseif character:FindFirstChild("Head") then
        return character.Head
    end
    
    -- Nếu không tìm thấy, thử tìm bất kỳ BasePart nào
    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            return part
        end
    end
    
    return nil
end

local function createBrainrotESP(character, player)
    local rootPart = findHumanoidRootPart(character)
    if not rootPart then return end
    
    local displayName = getPlayerDisplayName(player)
    
    -- Tạo BillboardGui
    local gui = Instance.new("BillboardGui")
    gui.Name = "BrainrotESP_" .. player.Name
    gui.Adornee = rootPart
    gui.Size = ESP_CONFIG.Size
    gui.StudsOffset = ESP_CONFIG.Offset
    gui.AlwaysOnTop = true
    gui.MaxDistance = 100  -- Chỉ hiển thị trong khoảng cách 100 studs
    gui.Parent = character

    -- Tạo background
    local bg = Instance.new("Frame")
    bg.Size = UDim2.new(1, 0, 1, 0)
    bg.BackgroundColor3 = ESP_CONFIG.Background.Color
    bg.BackgroundTransparency = ESP_CONFIG.Background.Transparency
    bg.BorderSizePixel = 0
    bg.Parent = gui

    -- Tạo label hiển thị tên
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextScaled = false
    label.Font = ESP_CONFIG.Text.Font
    label.TextSize = ESP_CONFIG.Text.Size
    label.TextColor3 = ESP_CONFIG.Text.Color
    label.TextStrokeTransparency = ESP_CONFIG.Text.StrokeTransparency
    label.TextStrokeColor3 = ESP_CONFIG.Text.StrokeColor
    label.Text = displayName
    label.Parent = bg

    -- Thêm viền brainrot
    if ESP_CONFIG.Border.Enabled then
        local stroke = Instance.new("UIStroke")
        stroke.Thickness = ESP_CONFIG.Border.Thickness
        stroke.Color = ESP_CONFIG.Border.Color
        stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        stroke.Parent = bg
    end

    -- Kết nối sự kiện hủy
    character.Destroying:Connect(function()
        if gui and gui.Parent then
            gui:Destroy()
        end
    end)
    
    table.insert(espList, gui)
    return gui
end

local function onCharacterAdded(character, player)
    -- Đợi nhân vật load hoàn chỉnh
    if not character:WaitForChild("Humanoid", 5) then return end
    
    -- Tạo ESP
    createBrainrotESP(character, player)
end

-- Xử lý kết nối player
local function setupPlayerESP(player)
    if player.Character then
        onCharacterAdded(player.Character, player)
    end
    
    player.CharacterAdded:Connect(function(character)
        onCharacterAdded(character, player)
    end)
end

-- Kết nối với player mới
Players.PlayerAdded:Connect(setupPlayerESP)

-- Xử lý các player đã có
for _, player in ipairs(Players:GetPlayers()) do
    if player ~= localPlayer then
        setupPlayerESP(player)
    end
end

-- Vòng lặp chính
while _G.BrainrotESPEnabled do
    -- Kiểm tra và cập nhật ESP định kỳ
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character then
            local existingESP = player.Character:FindFirstChild("BrainrotESP_" .. player.Name)
            if not existingESP then
                createBrainrotESP(player.Character, player)
            end
        end
    end
    task.wait(1)  -- Kiểm tra mỗi giây
end

-- Dọn dẹp khi tắt script
clearESP()
